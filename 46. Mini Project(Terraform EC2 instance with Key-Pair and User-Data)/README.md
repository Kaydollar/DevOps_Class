# MINI PROJECT - TERRAFORM EC2 INSTANCE WITH KEY PAIR AND USER DATA.

**Purpose: In this Mini Project, we will use Terrafoorm to automate the launch of an EC2 instance on AWS. This project includes the generation of a downloadable key pair for instance and the execution of a user data script to install and configure Apache HTTP server.**

**Objectives:**
1. **Terraform Configuration:**
- Learn how to write Terraform code to launch an EC2 Instance with specified configurations.

2. **Key Pair Generation:**
- Generate a key pair and make it downloadable after EC2 instance creation.

3. **User Data Execution:**
- Use Terraform to execute a user data script on the EC2 instance during launch.

## Project Task:
**TASK 1: Terraform configuration for EC2 instance**
1. Create a new directory for your terraform project (`terraform-ec2-keypair`)
![](1.%20mkdir.png)

2. Inside the directory, create a terraform configuration file (main.tf)
![](2.%20main.tf.png)

3. Write Temiform code to create an EC2 instance with the following specifications:
- Instance type: `t2.micro`
- Key pair: Generate a new key pair and make it downloadable.
- Security group: Allow incoming traffic on port 80.
```bash
provider "aws" {
  region = "us-east-1" # Change this to your desired AWS region
}

# Create Key Pair from existing public key
resource "aws_key_pair" "example_keypair" {
  key_name   = "example-keypair"
  public_key = file("~/.ssh/id_rsa.pub") # Replace with your public key path
}

# Create EC2 Instance
resource "aws_instance" "example_instance" {
  ami           = "ami-0c55b159cbfafe1f0" # Amazon Linux 2 AMI (example for us-east-1)
  instance_type = "t2.micro"
  key_name      = aws_key_pair.example_keypair.key_name

  vpc_security_group_ids = ["sg-0123456789abcdef0"] # Replace with your SG ID

  # Install Apache and serve a web page
  user_data = <<-EOF
              #!/bin/bash
              yum update -y
              yum install -y httpd
              systemctl start httpd
              systemctl enable httpd
              echo "<h1>Hello World from $(hostname -f)</h1>" > /var/www/html/index.html
              EOF

  tags = {
    Name = "Example-Terraform-Instance"
  }
}

# Output Public IP
output "public_ip" {
  value = aws_instance.example_instance.public_ip
}
```
![](3.%20Cat%20main.tf.png)

4. Initialize the Terraform project using the command: `terraforn init`
![](4.%20terraform%20init.png)

5. `terraform plan`
![](5.%20terraform%20plan.png)

![](6.%20terraform%20plan.png)

6. Apply the Terraform configuration to create the EC2 instance using the command: `terraform apply`

![](7.%20terraform%20apply.png)

![](8.%20terraform%20apply.png)

7. Confirmation on the AWS account.
![](9.%20Confirmed.png)

**TASK 2: USER DATA SCRIPT EXECUTION**
1. Extend your terraform configuration to include the execution of the provided user data script. 
    1. Create the User Data script file
        - Create a file in the same folder as your `main.tf` called:`userdata.sh`
```bash
    #!/bin/bash
# Update all packages
yum update -y

# Install Apache HTTP Server
yum install -y httpd

# Start Apache service
systemctl start httpd

# Enable Apache to start at boot
systemctl enable httpd

# Create a custom index.html file
echo "<h1>Hello World from Terraform on $(hostname -f)</h1>" > /var/www/html/index.html
```
![](10.%20userdata.tf.png)
    2. Update main.tf to reference the script
- We replace the inline heredoc with file() so Terraform reads the script:
```bash
provider "aws" {
  region = "us-east-1"
}

# Create Key Pair from existing public key
resource "aws_key_pair" "example_keypair" {
  key_name   = "example-keypair"
  public_key = file("~/.ssh/id_rsa.pub")
}

# Create EC2 Instance
resource "aws_instance" "example_instance" {
  ami           = "ami-0c55b159cbfafe1f0"
  instance_type = "t2.micro"
  key_name      = aws_key_pair.example_keypair.key_name

  vpc_security_group_ids = ["sg-0123456789abcdef0"]

  # Read user data from external script
  user_data = file("${path.module}/userdata.sh")

  tags = {
    Name = "Example-Terraform-Instance"
  }
}

# Output Public IP
output "public_ip" {
  value = aws_instance.example_instance.public_ip
}
```

2. Modify the user data script to install and configure Apache HTTP server.

3. Apply the updated Terraform configuration to launch the EC2 instance with the user data script using the command: `terraform apply`

**TASK 3: ACCESSING THE WEB SERVER**
1. After the EC2 instance is created and running, access the Apache web server by using the public IP address, You can use the command to display your Public IP address: `terraform output public_ip`

![](11.%20Piblic%20IP.png)

2. Verify that the web server displays the "Hello World" message generated by the user data script.
![](12.%20Hello%20world.png)

NB: [REF link](https://chatgpt.com/share/689f2207-b2e8-8010-804c-a286810300b0) .


Updated main.tf
```bash
provider "aws" {
  region = "us-east-1" # Change this to your desired AWS region
}

# Create Key Pair from existing public key
resource "aws_key_pair" "example_keypair" {
  key_name   = "example-keypair"
  public_key = file("C:/Users/Kola/.ssh/id_rsa.pub") # Windows full path
}

# Create Security Group with HTTP and SSH access
resource "aws_security_group" "allow_http_ssh" {
  name        = "allow_http_ssh"
  description = "Allow inbound HTTP and SSH traffic"

  # Allow HTTP (Port 80) from anywhere
  ingress {
    description = "Allow HTTP"
    from_port   = 80
    to_port     = 80
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
  }

  # Allow SSH (Port 22) from anywhere
  ingress {
    description = "Allow SSH"
    from_port   = 22
    to_port     = 22
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
  }

  # Allow all outbound traffic
  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
  }
}

# Create EC2 Instance
resource "aws_instance" "example_instance" {
  ami           = "ami-0de716d6197524dd9" # Amazon Linux 2 AMI (for us-east-1)
  instance_type = "t2.micro"
  key_name      = aws_key_pair.example_keypair.key_name

  # Attach Security Group
  vpc_security_group_ids = [aws_security_group.allow_http_ssh.id]

  # Install Apache and serve a test page
  user_data = <<-EOF
              #!/bin/bash
              yum update -y
              yum install -y httpd
              systemctl start httpd
              systemctl enable httpd
              echo "<h1>Hello World from $(hostname -f)</h1>" > /var/www/html/index.html
              EOF

  tags = {
    Name = "Example-Terraform-Instance"
  }
}

# Output Public IP
output "public_ip" {
  value = aws_instance.example_instance.public_ip
}
```




